<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/default.min.css"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="@Observable vs @AppStorage Conflict: Part 2" /><meta property="og:locale" content="en_US" /><meta name="description" content="Explore the intricate relationship between @Observable and @AppStorage in SwiftUI in this detailed guide. Learn what triggers conflicts between these two features and gain insights into their operational mechanisms. Perfect for developers looking to deepen their understanding of SwiftUI’s architecture and improve their coding practices" /><meta property="og:description" content="Explore the intricate relationship between @Observable and @AppStorage in SwiftUI in this detailed guide. Learn what triggers conflicts between these two features and gain insights into their operational mechanisms. Perfect for developers looking to deepen their understanding of SwiftUI’s architecture and improve their coding practices" /><link rel="canonical" href="http://localhost:4000/2024/05/05/unpacking-observable-and-appstorage-part-2" /><meta property="og:url" content="http://localhost:4000/2024/05/05/unpacking-observable-and-appstorage-part-2" /><meta property="og:site_name" content="Sidey" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-05-05T00:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="@Observable vs @AppStorage Conflict: Part 2" /><meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-05T00:00:00-04:00","datePublished":"2024-05-05T00:00:00-04:00","description":"Explore the intricate relationship between @Observable and @AppStorage in SwiftUI in this detailed guide. Learn what triggers conflicts between these two features and gain insights into their operational mechanisms. Perfect for developers looking to deepen their understanding of SwiftUI’s architecture and improve their coding practices","headline":"@Observable vs @AppStorage Conflict: Part 2","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2024/05/05/unpacking-observable-and-appstorage-part-2"},"url":"http://localhost:4000/2024/05/05/unpacking-observable-and-appstorage-part-2"}</script><title> @Observable vs @AppStorage Conflict: Part 2 - Sidey</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="Sidey" href="/atom.xml"><link rel="alternate" type="application/json" title="Sidey" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:var(--base-font-size);background-color:var(--background-color);color:var(--text-color)}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}nav ul{border-right:1px solid #edf2f7}a{color:var(--link-color);text-decoration-skip-ink:auto;text-decoration:underline}a:hover{color:var(--link-hover-color);text-decoration:none}a:active{color:var(--link-hover-color);text-decoration:underline}pre{tab-size:2;word-wrap:break-word;page-break-inside:avoid;padding:.5rem;overflow-x:auto;border:1px solid #ccc;box-shadow:1px 1px 5px rgba(0,0,0,.1);background-color:var(--code-block-bg-color)}code,pre{font-family:"Fira Code","Consolas",monospace}code.language-plaintext{font-style:italic;color:var(--plaintext-color);background:var(--plaintext-bg);font-size:calc(.875*var(--base-font-size))}pre code{border:none;display:block;background:none;white-space:pre;-webkit-overflow-scrolling:touch;overflow-x:scroll;max-width:100%;min-width:100px;padding:0}.meta{margin:2rem 0}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:10px solid #ccc;margin:1.5em 10px;padding:.5em 10px;quotes:"“" "”" "‘" "’";word-wrap:break-all}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:.5rem}}figcaption{font-size:smaller}@media print{.no-print,.no-print *{display:none !important}}:root{--base-font-size: 14px;--background-color: #fff;--text-color: rgb(22, 23, 26);--link-color: #000;--link-hover-color: lightsteelblue;--border-color: #edf2f7;--code-block-bg-color: rgb(248, 248, 248);--plaintext-bg: #ffeff0;--plaintext-color: crimson}@media(prefers-color-scheme: dark){:root{--background-color: #333;--text-color: #fff;--link-color: #ddd;--link-hover-color: #5f9ea0;--border-color: #555;--code-block-bg-color: #444;--plaintext-bg: #442b2d;--plaintext-color: #ffb3b3}}h1{font-size:calc(2.25*var(--base-font-size))}h2{font-size:calc(2*var(--base-font-size))}h3{font-size:calc(1.75*var(--base-font-size))}h4{font-size:calc(1.5*var(--base-font-size))}h5{font-size:calc(1.25*var(--base-font-size))}h6{font-size:calc(1.125*var(--base-font-size))}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}p,li,a,span,div{font-size:var(--base-font-size)}section.post{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}section.post h1:first-child{margin-top:0}section.post h1:first-child+p{margin-top:0}section.post p{display:block;margin-top:12px}section.post code.language-plaintext{background-color:#d3d3d3;color:#8b4513}section.post h2,section.post h3,section.post h4,section.post h5,section.post h6{margin:2rem 0 0}section.post h2+p,section.post h3+p,section.post h4+p,section.post h5+p,section.post h6+p{margin-top:5px}section.post ul,section.post ol{list-style:none;margin-top:12px;list-style-position:inside;counter-reset:item}section.post ul li,section.post ol li{position:relative;margin-bottom:24px;counter-increment:item}section.post ul li::before,section.post ol li::before{content:counter(item) ". ";position:absolute;left:0;top:0}section.post ul li p,section.post ol li p{margin-left:22px;margin-top:12px}section.post ul li p:first-child,section.post ol li p:first-child{margin-top:0}section.post ul li p:first-child+p,section.post ol li p:first-child+p{margin-top:0}section.post ul li p:not(:first-child):not(:nth-child(2)),section.post ol li p:not(:first-child):not(:nth-child(2)){margin-top:12px}section.post ul li div.language-swift.highlighter-rouge,section.post ol li div.language-swift.highlighter-rouge{margin-left:22px}section.post ul li pre,section.post ol li pre{margin:0}section.post ul li details,section.post ol li details{margin-left:30px}section.post ul li details summary,section.post ol li details summary{margin-left:0px}section.post ul ul,section.post ol ul{counter-reset:none;list-style:circle;margin-left:20px;margin-top:5px}section.post ul ul li,section.post ol ul li{counter-increment:none;position:static;margin-left:24px;margin-bottom:0}section.post ul ul li::before,section.post ol ul li::before{content:none}section.post ul ul li:last-child,section.post ol ul li:last-child{margin-bottom:24px}section.post nav ol,section.post nav ul{counter-reset:none}section.post nav ol li,section.post nav ul li{counter-increment:none}section.post nav ol li::before,section.post nav ul li::before{content:none}section.post ul.nested{counter-reset:none;list-style:circle;margin-left:20px;margin-top:5px}section.post ul.nested li{counter-increment:none;position:static;margin-left:24px;margin-bottom:0}section.post ul.nested li::before{content:none}section.post ul.nested li:last-child{margin-bottom:24px}</style></head><body><main><header aria-hidden="true" class="no-print"> <!--<h1 class="logo">Sidey</h1>--><nav role="navigation" aria-hidden="true"><ul><li><a href="/" >Writing</a></li><li><a href="/about" >About</a></li><li><a href="/search" >Search</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h1>@Observable vs @AppStorage Conflict: Part 2</h1><p>In the previous article, we explored the conflict that arises when combining @Observable and @AppStorage. This follow-up provides a solution grounded in an understanding observation, identity, and the distinctions between reference and structural semantics.</p><h2 id="important-background-reference-and-structural-semantics"><u>Important Background: Reference and Structural Semantics</u></h2><ul><li><p><strong>Reference Semantics</strong>: refers to objects where multiple variables can refer to the same instance in memory. Any changes made through one reference affect the underlying object and, consequently, all other references to it.</p><blockquote><p><strong>Tip</strong>: Think of reference types (e.g., classes, functions) when considering reference semantics - there are are allocated in shared memory spaces and accessed via pointers.</p></blockquote></li><li><p>Structural Semantics: in contrast, this pertains to objects where variables hold independent copies of data. Modifications to one variable do not impact others.</p><blockquote><p>Value types (e.g., structs, enums, tuples) are examples of structural semantics, emphasizing independent data handling</p></blockquote></li></ul><h2 id="conflict-overview"><u>Conflict Overview</u></h2><p><strong>@Observable</strong> converts all stored properties in a class to computed properties to enable detailed observation, leveraging reference semantics for unique change tracking. Conversely, <strong>@AppStorage</strong> is a property wrapper for direct interaction with UserDefaults, relying on its own getter and setter methods and typically aligning with structural semantics.</p><h2 id="the-solution"><u>The Solution</u></h2><p>The key to resolving the conflict lies in ensuring that <strong>@AppStorage</strong> adheres to reference semantics when used within an @Observable class: The <a href="https://forums.swift.org/t/pitch-observation/62051#detailed-design-8">design details section of the original pitch</a> provides guidance:</p><blockquote><p>Observation of an entity implies that entity has identity. That means that things that are observable are inherently reference types. Structural types that are not rooted in a reference semantic storage do not have a well formed concept of external observation of changes. However, if the structure is a member variable of a reference type, descendant key paths to specific values passing through structural types with a root of a reference type do make sense as being an observable field.</p></blockquote><p>To implement a solution alighed with these principles, first move properties annotated with <strong>@AppStorage</strong> into a reference type:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">Storage</span> <span class="p">{</span>
    <span class="kd">@AppStorage</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">name</span> <span class="o">=</span> <span class="s">"johnDoe"</span>
    <span class="kd">@AppStorage</span><span class="p">(</span><span class="s">"age"</span><span class="p">)</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">age</span> <span class="o">=</span> <span class="mi">12</span>
    
    <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div><p>Next the reference type, <code class="language-plaintext highlighter-rouge">Storage</code> is integrated into an observable class (<code class="language-plaintext highlighter-rouge">UserSettings</code>) and made a member variable of said class:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">SwiftUI</span>
<span class="kd">@Observable</span> <span class="kd">class</span> <span class="kt">UserSettings</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">Storage</span> <span class="p">{</span>
        <span class="kd">@AppStorage</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">name</span> <span class="o">=</span> <span class="s">"johnDoe"</span>
        <span class="kd">@AppStorage</span><span class="p">(</span><span class="s">"age"</span><span class="p">)</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">age</span> <span class="o">=</span> <span class="mi">12</span>
        
        <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span> <span class="kt">Storage</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div><p>Finally the property observer <code class="language-plaintext highlighter-rouge">didSet</code> is added for each variable we want to observe and update:</p><div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">SwiftUI</span>
<span class="kd">@Observable</span> <span class="kd">class</span> <span class="kt">UserSettings</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">Storage</span> <span class="p">{</span>
        <span class="kd">@AppStorage</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">name</span> <span class="o">=</span> <span class="s">"johnDoe"</span>
        <span class="kd">@AppStorage</span><span class="p">(</span><span class="s">"age"</span><span class="p">)</span> <span class="kd">public</span> <span class="k">var</span> <span class="nv">age</span> <span class="o">=</span> <span class="mi">12</span>
        
        <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span> <span class="kt">Storage</span><span class="p">()</span>
    
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
      <span class="k">didSet</span> <span class="p">{</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">age</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
      <span class="k">didSet</span> <span class="p">{</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="code-breakdown">Code Breakdown:</h4><p>Each property in <code class="language-plaintext highlighter-rouge">UserSettings</code> is backed by a corresponding property in the <code class="language-plaintext highlighter-rouge">Storage</code> class.</p><ul><li><p><strong>Direct Access and Persistence</strong>: when a property (e.g. <em>name</em>) in <code class="language-plaintext highlighter-rouge">UserSettings</code> is set, its <code class="language-plaintext highlighter-rouge">didSet</code> observe updates the corresponding value in the <code class="language-plaintext highlighter-rouge">Storage</code> instance, which immediately saves it in <code class="language-plaintext highlighter-rouge">UserDefaults</code> via the <code class="language-plaintext highlighter-rouge">AppStorage</code> wrapper.</p></li><li><p><strong>Initialization and Synchronization</strong>: when <code class="language-plaintext highlighter-rouge">UserSettings</code> is initialized, it sets its properties from the corresponding values in <code class="language-plaintext highlighter-rouge">Stroage</code>, which reads these values from <code class="language-plaintext highlighter-rouge">UserDefaults</code>. This ensures that a user’s settings are populated with the previously saved values when the app starts. With <code class="language-plaintext highlighter-rouge">@AppStorage</code> properties encapsulated in a distinct reference type (<code class="language-plaintext highlighter-rouge">Storage</code>), <code class="language-plaintext highlighter-rouge">UserSettings</code> is able to indirectly access <code class="language-plaintext highlighter-rouge">@AppStorage</code> properties through <code class="language-plaintext highlighter-rouge">Storage</code>, enabling observation via <code class="language-plaintext highlighter-rouge">@Observable</code> while avoiding direct application of <code class="language-plaintext highlighter-rouge">@AppStorage</code>.</p></li></ul><p>This approch effectively organizes data handling and observing changes in <code class="language-plaintext highlighter-rouge">UserSettings</code> by leveraging the strengths of both <code class="language-plaintext highlighter-rouge">@AppStorage</code> for persistent storage and <code class="language-plaintext highlighter-rouge">@Observable</code> for observing and responding to changes.</p><span class="meta"><time datetime="2024-05-05T00:00:00-04:00">May 5, 2024</time> &middot; <a href="/tag/swiftui">swiftui</a>, <a href="/tag/swift">swift</a>, <a href="/tag/observation">observation</a>, <a href="/tag/property wrappers">property wrappers</a>, <a href="/tag/observable">observable</a>, <a href="/tag/appstorage">appstorage</a></span></section></main><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/swift.min.js"></script> <script>hljs.highlightAll();</script></body></html>
